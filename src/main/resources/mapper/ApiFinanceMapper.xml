<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.qydata.mapper.ApiFinanceMapper">

    <resultMap id="CustomerFinance_Map" type="org.qydata.dst.CustomerFinance">
        <result column="id" property="id"/>
        <result column="companyId" property="companyId"/>
        <result column="companyName" property="companyName"/>
        <result column="balance" property="balance"/>
        <result column="chargeWeekTotleAmount" property="chargeWeekTotleAmount"/>
        <result column="chargeMonthTotleAmount" property="chargeMonthTotleAmount"/>
        <result column="consumeWeekTotleAmount" property="consumeWeekTotleAmount"/>
        <result column="consumeMonthTotleAmount" property="consumeMonthTotleAmount"/>
        <result column="chargeTotleAmount" property="chargeTotleAmount"/>
        <result column="consumeTotleAmount" property="consumeTotleAmount"/>
    </resultMap>

    <resultMap type="CustomerBalanceLog" id="CustomerBalanceLog_Map">
        <id column="id" property="id"/>
        <result column="reasonId" property="reasonId"/>
        <result column="amount" property="amount"/>
        <result column="customerId" property="customerId"/>
        <result column="createTime" property="createTime"/>
    </resultMap>

    <resultMap type="CustomerBalanceLog" id="CustomerBalanceLog_CustomerBalanceModifyReason_Map" extends="CustomerBalanceLog_Map">
        <association property="customerBalanceModifyReason" javaType="CustomerBalanceModifyReason">
            <result column="reasonName" property="name"/>
        </association>
    </resultMap>

    <resultMap id="ApiType_Map" type="ApiType">
        <result column="apiTypeId" property="id"/>
        <result column="typeName" property="name"/>
    </resultMap>

    <resultMap id="ApiType_CustomerApiVendor_Map" type="ApiType" extends="ApiType_Map">
        <collection property="customerApiVendorList" ofType="org.qydata.dst.CustomerApiVendor">
            <result column="apiId" property="apiId"/>
            <result column="totlePrice" property="totlePrice"/>
            <result column="vendorName" property="vendorName"/>
            <result column="vendorId" property="vendorId"/>
        </collection>
    </resultMap>

    <resultMap id="CustomerApiVendor_Map" type="org.qydata.dst.CustomerApiVendor" >
        <result column="apiId" property="apiId"/>
        <result column="apiName" property="apiName"/>
        <result column="totlePrice" property="totlePrice"/>
        <result column="vendorName" property="vendorName"/>
        <result column="vendorId" property="vendorId"/>
        <result column="reasonId" property="reasonId"/>
        <result column="reasonName" property="reasonName"/>
    </resultMap>
    <!--查询客户的财务总览-->
    <select id="queryApiOverAllFinance" parameterType="map" resultMap="CustomerApiVendor_Map">
       SELECT a.id,a.name apiName,a.apiTypeId,b.name apiTypeName,a.vendorId,a.vendorName,c.balance
       FROM qydata.vwApi a LEFT JOIN qydata.vwApiType b
       ON a.apiTypeId=b.id LEFT JOIN qyfinance.ApiBalance c ON a.id=c.apiId
    </select>

    <!--查询客户的充值记录-->
    <select id="queryCompanyCustomerRechargeRecordByCustomerId" parameterType="map" resultMap="CustomerBalanceLog_CustomerBalanceModifyReason_Map">
        SELECT id,reasonId,amount,customerId,createTime,reasonName
        FROM qydata.vwCustomerBalanceLog
        WHERE customerId=#{customerId}
        <if test="reasonIdList != null and reasonIdList.size() != 0">
            AND reasonId IN
            <foreach collection="reasonIdList" item="reasonId" index="index" open="(" close=")" separator=",">
                #{reasonId}
            </foreach>
        </if>
        <if test="beginDate != null and beginDate != ''">
            <![CDATA[
            AND createTime>=str_to_date(#{beginDate},'%m/%d/%Y %H:%i:%s')
            ]]>
        </if>
        <if test="endDate != null and endDate != ''">
            <![CDATA[
            AND createTime<=str_to_date(#{endDate},'%m/%d/%Y %H:%i:%s')
             ]]>
        </if>
        ORDER BY createTime DESC
    </select>

    <!--查询客户的Api消费记录-->
    <select id="queryCompanyCustomerApiConsumeRecordByCustomerId" parameterType="map" resultMap="ApiType_CustomerApiVendor_Map">
        select ee.apiTypeId,ff.name typeName,ee.apiId,ee.totlePrice,ee.vendorName,ee.vendorId
        from
        (
            select cc.apiTypeId,cc.apiId,cc.totlePrice,dd.vendorName,dd.vendorId
            from
            (
                select b.apiTypeId,b.apiId,sum(a.amount) totlePrice
                from qydata.vwCustomerBalanceLog a LEFT JOIN qydata.vwCustomerRequestLog b
                ON a.reqId=b.id
                where a.reasonId in(-1,-2) and b.hasCost=1
                and a.customerId=#{customerId}
                group by b.apiTypeId,b.apiId
            ) cc LEFT JOIN qydata.vwApi dd
            ON cc.apiId = dd.id
        ) ee LEFT JOIN qydata.vwApiType ff
        ON ee.apiTypeId=ff.id
        <where>
            <if test="apiTypeId != null and apiTypeId != ''">
                ee.apiTypeId=#{apiTypeId}
            </if>
            <if test="apiVendorId != null and apiVendorId != ''">
                AND ee.vendorId=#{apiVendorId}
            </if>
        </where>
    </select>

    <!--查询客户的Api消费明细记录-->
    <select id="queryCompanyCustomerApiDetailConsumeRecordByCustomerId" parameterType="map" resultMap="CustomerApiVendor_Map">
        select ee.apiTypeId,ff.name typeName,ee.apiId,ee.reasonId,ee.reasonName,ee.totlePrice,ee.vendorName,ee.vendorId,ee.apiName
        from
        (
            select cc.apiTypeId,cc.apiId,cc.reasonId,cc.reasonName,cc.totlePrice,dd.vendorName,dd.vendorId,dd.name apiName
            from
            (
                select aa.apiTypeId,aa.apiId,aa.reasonId,bb.name reasonName,aa.totlePrice
                from
                (
                    select b.apiTypeId,b.apiId,a.reasonId,sum(a.amount) totlePrice
                    from qydata.vwCustomerBalanceLog a LEFT JOIN qydata.vwCustomerRequestLog b
                    ON a.reqId=b.id
                    where a.reasonId in(-1,-2) and b.hasCost=1
                    and a.customerId=#{customerId}
                    group by b.apiTypeId,b.apiId,a.reasonId
                ) aa LEFT JOIN qydata.CustomerBalanceModifyReason bb
                ON aa.reasonId=bb.id
            ) cc LEFT JOIN qydata.vwApi dd
            ON cc.apiId = dd.id
        ) ee LEFT JOIN qydata.vwApiType ff
        ON ee.apiTypeId=ff.id
        WHERE ee.apiTypeId=#{apiTypeId}
        <if test="reasonIdList != null and reasonIdList.size() > 0">
            AND ee.reasonId IN
            <foreach collection="reasonIdList" item="reasonId" index="index" open="(" close=")" separator=",">
                #{reasonId}
            </foreach>
        </if>
    </select>

    <!--查询客户的周月记录-->
    <select id="queryCompanyCustomerWeekMonthRecordByCustomerId" parameterType="map" resultType="WeekMonthAmount">
        SELECT years,months,weeks,totleAmount,customerId,tableId,weekMonthTypeId,name,beginTime,endTime
        FROM qyfinance.vwWeekMonthAmount
        WHERE customerId=#{customerId}
        AND weekMonthTypeId=#{weekMonthTypeId}
        <if test="years != null and years != ''">
            AND years=#{years}
        </if>
        <if test="months != null and months != ''">
            AND months=#{months}
        </if>
        <if test="weeks != null and weeks != ''">
            AND weeks=#{weeks}
        </if>
        <if test="tableIdList != null and tableIdList.size() > 0">
            AND tableId IN
            <foreach collection="tableIdList" item="tableId" index="index" open="(" close=")" separator=",">
                #{tableId}
            </foreach>
        </if>
    </select>

    <!--查询客户的周月记录年级联菜单-->
    <select id="queryCompanyCustomerYearsByCustomerId" parameterType="map" resultType="int">
        SELECT DISTINCT(years)
        FROM qyfinance.vwWeekMonthAmount
        WHERE customerId=#{customerId} AND weekMonthTypeId=#{weekMonthTypeId}
        <if test="years != null and years != ''">
            AND years=#{years}
        </if>
        <if test="months != null and months != ''">
            AND months=#{months}
        </if>
        <if test="weeks != null and weeks != ''">
            AND weeks=#{weeks}
        </if>
        <if test="tableIdList != null and tableIdList.size() > 0">
            AND tableId IN
            <foreach collection="tableIdList" item="tableId" index="index" open="(" close=")" separator=",">
                #{tableId}
            </foreach>
        </if>
    </select>

    <!--查询客户的周月记录月级联菜单-->
    <select id="queryCompanyCustomerMonthsByCustomerId" parameterType="map" resultType="int">
        SELECT DISTINCT(months)
        FROM qyfinance.vwWeekMonthAmount
        WHERE customerId=#{customerId}
        <if test="weekMonthTypeId != null and weekMonthTypeId != ''">
            AND weekMonthTypeId=#{weekMonthTypeId}
        </if>
        <if test="years != null and years != ''">
            AND years=#{years}
        </if>
        <if test="tableIdList != null and tableIdList.size() > 0">
            AND tableId IN
            <foreach collection="tableIdList" item="tableId" index="index" open="(" close=")" separator=",">
                #{tableId}
            </foreach>
        </if>
    </select>

    <!--查询客户的周月记录周级联菜单-->
    <select id="queryCompanyCustomerWeeksByCustomerId" parameterType="map" resultType="int">
        SELECT DISTINCT(weeks)
        FROM qyfinance.vwWeekMonthAmount
        WHERE customerId=#{customerId} AND weekMonthTypeId=#{weekMonthTypeId}
        <if test="years != null and years != ''">
            AND years=#{years}
        </if>
        <if test="months != null and months != ''">
            AND months=#{months}
        </if>
        <if test="weeks != null and weeks != ''">
            AND weeks=#{weeks}
        </if>
        <if test="tableIdList != null and tableIdList.size() > 0">
            AND tableId IN
            <foreach collection="tableIdList" item="tableId" index="index" open="(" close=")" separator=",">
                #{tableId}
            </foreach>
        </if>
    </select>


</mapper>

