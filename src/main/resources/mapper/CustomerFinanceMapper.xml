<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.qydata.mapper.CustomerFinanceMapper">

    <resultMap id="CustomerFinance_Map" type="org.qydata.dst.CustomerFinance">
        <result column="id" property="id"/>
        <result column="companyId" property="companyId"/>
        <result column="companyName" property="companyName"/>
        <result column="balance" property="balance"/>
        <result column="chargeWeekTotleAmount" property="chargeWeekTotleAmount"/>
        <result column="chargeMonthTotleAmount" property="chargeMonthTotleAmount"/>
        <result column="consumeWeekTotleAmount" property="consumeWeekTotleAmount"/>
        <result column="consumeMonthTotleAmount" property="consumeMonthTotleAmount"/>
        <result column="chargeTotleAmount" property="chargeTotleAmount"/>
        <result column="consumeTotleAmount" property="consumeTotleAmount"/>
    </resultMap>

    <resultMap type="CustomerBalanceLog" id="CustomerBalanceLog_Map">
        <id column="id" property="id"/>
        <result column="reasonId" property="reasonId"/>
        <result column="amount" property="amount"/>
        <result column="customerId" property="customerId"/>
        <result column="createTime" property="createTime"/>
    </resultMap>

    <resultMap type="CustomerBalanceLog" id="CustomerBalanceLog_CustomerBalanceModifyReason_Map" extends="CustomerBalanceLog_Map">
        <association property="customerBalanceModifyReason" javaType="CustomerBalanceModifyReason">
            <result column="reasonName" property="name"/>
        </association>
    </resultMap>

    <resultMap id="ApiType_Map" type="ApiType">
        <result column="apiTypeId" property="id"/>
        <result column="typeName" property="name"/>
    </resultMap>

    <resultMap id="ApiType_CustomerApiVendor_Map" type="ApiType" extends="ApiType_Map">
        <collection property="customerApiVendorList" ofType="org.qydata.dst.CustomerApiVendor">
            <result column="apiId" property="apiId"/>
            <result column="totlePrice" property="totlePrice"/>
            <result column="vendorName" property="vendorName"/>
            <result column="vendorId" property="vendorId"/>
        </collection>
    </resultMap>
    <!--查询客户的财务总览-->
    <select id="queryCompanyCustomerOverAllFinance" parameterType="map" resultMap="CustomerFinance_Map">
        SELECT kk.id,kk.companyId,kk.companyName,kk.balance,kk.chargeWeekTotleAmount,kk.chargeMonthTotleAmount,kk.consumeWeekTotleAmount,
        kk.consumeMonthTotleAmount,kk.chargeTotleAmount,ll.consumeTotleAmount
        FROM
        (SELECT ii.id,ii.companyId,ii.companyName,ii.balance,ii.chargeWeekTotleAmount,ii.chargeMonthTotleAmount,ii.consumeWeekTotleAmount,
        ii.consumeMonthTotleAmount,jj.chargeTotleAmount
        FROM
        (SELECT gg.id,gg.companyId,gg.companyName,gg.balance,gg.chargeWeekTotleAmount,gg.chargeMonthTotleAmount,gg.consumeWeekTotleAmount,
        hh.consumeMonthTotleAmount
        FROM
        (SELECT ee.id,ee.companyId,ee.companyName,ee.balance,ee.chargeWeekTotleAmount,ee.chargeMonthTotleAmount,ff.consumeWeekTotleAmount
        FROM
        (SELECT cc.id,cc.companyId,cc.companyName,cc.balance,cc.chargeWeekTotleAmount,dd.chargeMonthTotleAmount
        FROM
        (SELECT aa.id,aa.typeId,aa.typeName,aa.name,aa.authId,aa.authPass,aa.createTime,aa.status,aa.statusName,aa.companyId,aa.companyName,aa.balance,bb.chargeWeekTotleAmount
        FROM
        (SELECT a.id,a.typeId,a.typeName,a.name,a.authId,a.authPass,a.balance,a.createTime,a.status,a.statusName,a.companyId,a.companyName,
        b.deptId,b.deptName
        FROM qydata.vwCustomer a,qyauth.vwCustomerDept b
        WHERE a.id=b.customerId
        <if test="deptIdList!=null and deptIdList.size()!=0">
            and b.deptId in
            <foreach collection="deptIdList" item="deptId" index="index" open="(" close=")" separator=",">
                #{deptId}
            </foreach>
        </if>
        <if test="customerTypeIdList!=null and customerTypeIdList.size()!=0">
            and a.typeId in
            <foreach collection="customerTypeIdList" item="customerTypeId" index="index" open="(" close=")" separator=",">
                #{customerTypeId}
            </foreach>
        </if>
        <if test="content!=null and content!=''">
            and a.companyName like '%${content}%'
        </if>
        ) aa LEFT JOIN
        (SELECT customerId,totleAmount chargeWeekTotleAmount
        FROM qyfinance.vwWeekMonthAmount
        WHERE weekMonthTypeId=1 AND tableName='CustomerBalanceLog' AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%Y')
        AND months=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%m') AND weeks=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%u')
        ) bb
        ON aa.id=bb.customerId
        ) cc LEFT JOIN
        (SELECT customerId,totleAmount chargeMonthTotleAmount
        FROM qyfinance.vwWeekMonthAmount
        WHERE weekMonthTypeId=2 AND tableName='CustomerBalanceLog' AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%Y')
        AND months=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%m')
        ) dd
        ON cc.id=dd.customerId
        ) ee LEFT JOIN
        (SELECT customerId,totleAmount consumeWeekTotleAmount
        FROM qyfinance.vwWeekMonthAmount
        WHERE weekMonthTypeId=1 AND tableName='CustomerRequestLogCustomerResponseLog' AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%Y')
        AND months=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%m') AND weeks=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%u')
        ) ff
        ON ee.id=ff.customerId
        ) gg LEFT JOIN
        (SELECT customerId,totleAmount consumeMonthTotleAmount
        FROM qyfinance.vwWeekMonthAmount
        WHERE weekMonthTypeId=2 AND tableName='CustomerRequestLogCustomerResponseLog' AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%Y')
        AND months=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%m')
        ) hh
        ON gg.id=hh.customerId
        ) ii LEFT JOIN
        (SELECT customerId,sum(totleAmount) chargeTotleAmount
        FROM qyfinance.vwWeekMonthAmount
        WHERE tableName='CustomerBalanceLog'
        GROUP BY customerId
        ) jj
        ON ii.id=jj.customerId
        ) kk LEFT JOIN
        (SELECT customerId,sum(totleAmount) consumeTotleAmount
        FROM qyfinance.vwWeekMonthAmount
        WHERE tableName='CustomerRequestLogCustomerResponseLog'
        GROUP BY customerId
        ) ll
        ON kk.id=ll.customerId
    </select>

    <!--查询客户的充值记录-->
    <select id="queryCompanyCustomerRechargeRecordByCustomerId" parameterType="map" resultMap="CustomerBalanceLog_CustomerBalanceModifyReason_Map">
        SELECT id,reasonId,amount,customerId,createTime,reasonName
        FROM qydata.vwCustomerBalanceLog
        WHERE customerId=#{customerId}
        <if test="reasonIdList != null and reasonIdList.size() != 0">
            AND reasonId IN
            <foreach collection="reasonIdList" item="reasonId" index="index" open="(" close=")" separator=",">
                #{reasonId}
            </foreach>
        </if>
        <if test="beginDate != null and beginDate != ''">
            <![CDATA[
            AND createTime>=str_to_date(#{beginDate},'%m/%d/%Y %H:%i:%s')
            ]]>
        </if>
        <if test="endDate != null and endDate != ''">
            <![CDATA[
            AND createTime<=str_to_date(#{endDate},'%m/%d/%Y %H:%i:%s')
             ]]>
        </if>
        ORDER BY createTime DESC
    </select>

    <!--查询客户的Api消费记录-->
    <select id="queryCompanyCustomerApiConsumeRecordByCustomerId" parameterType="map" resultMap="ApiType_CustomerApiVendor_Map">
        SELECT cc.apiTypeId,dd.name typeName,cc.apiId,cc.totlePrice,cc.vendorName,cc.vendorId
        FROM
        (
        SELECT aa.apiTypeId,aa.apiId,aa.totlePrice,bb.vendorName,bb.vendorId
        FROM
        (
        SELECT a.apiTypeId,a.apiId,sum(b.price) totlePrice
        FROM qydata.vwCustomerRequestLog a left join qydata.vwCustomerApi b
        on a.customerId=b.customerId
        where a.apiId=b.apiId
        AND a.customerId=#{customerId}
        AND a.apiId IS NOT NULL
        AND a.hasCost=1
        group by a.apiTypeId,a.apiId
        ) aa LEFT JOIN qydata.vwApi bb
        ON aa.apiId = bb.id
        ) cc LEFT JOIN qydata.vwApiType dd
        ON cc.apiTypeId=dd.id
        <where>
            <if test="apiTypeId != null and apiTypeId != ''">
                cc.apiTypeId=#{apiTypeId}
            </if>
            <if test="apiVendorId != null and apiVendorId != ''">
                AND cc.vendorId=#{apiVendorId}
            </if>
        </where>
    </select>

</mapper>

