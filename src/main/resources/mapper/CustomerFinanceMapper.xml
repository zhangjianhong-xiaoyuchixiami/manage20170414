<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.qydata.mapper.CustomerFinanceMapper">

    <resultMap id="CustomerFinance_Map" type="org.qydata.dst.CustomerFinance">
        <result column="id" property="id"/>
        <result column="companyId" property="companyId"/>
        <result column="companyName" property="companyName"/>
        <result column="balance" property="balance"/>
        <result column="partnerId" property="partnerId"/>
        <result column="partnerName" property="partnerName"/>
        <result column="chargeWeekTotleAmount" property="chargeWeekTotleAmount"/>
        <result column="chargeMonthTotleAmount" property="chargeMonthTotleAmount"/>
        <result column="consumeWeekTotleAmount" property="consumeWeekTotleAmount"/>
        <result column="consumeMonthTotleAmount" property="consumeMonthTotleAmount"/>
        <result column="chargeTotleAmount" property="chargeTotleAmount"/>
        <result column="consumeTotleAmount" property="consumeTotleAmount"/>
    </resultMap>

    <resultMap id="CustomerFinance_CompanyApi_Map" type="org.qydata.dst.CustomerFinance" extends="CustomerFinance_Map">
        <collection property="companyApiList" ofType="org.qydata.entity.CompanyApi">
            <result column="apiTypeId" property="apiTypeId"/>
            <result column="subTypeId" property="subTypeId"/>
            <result column="price" property="price"/>
            <association property="apiType" javaType="org.qydata.entity.ApiType">
                <result column="apiTypeName" property="name"/>
            </association>
            <association property="mobileOperator" javaType="org.qydata.entity.MobileOperator">
                <result column="subTypeName" property="name"/>
            </association>
        </collection>
    </resultMap>

    <resultMap type="org.qydata.entity.CustomerBalanceLog" id="CustomerBalanceLog_Map">
        <id column="id" property="id"/>
        <result column="reasonId" property="reasonId"/>
        <result column="amount" property="amount"/>
        <result column="customerId" property="customerId"/>
        <result column="createTime" property="createTime"/>
    </resultMap>

    <resultMap type="org.qydata.entity.CustomerBalanceLog" id="CustomerBalanceLog_CustomerBalanceModifyReason_Map" extends="CustomerBalanceLog_Map">
        <association property="customerBalanceModifyReason" javaType="org.qydata.entity.CustomerBalanceModifyReason">
            <result column="reasonName" property="name"/>
        </association>
    </resultMap>

    <resultMap id="ApiType_Map" type="org.qydata.entity.ApiType">
        <result column="apiTypeId" property="id"/>
        <result column="typeName" property="name"/>
    </resultMap>

    <resultMap id="ApiType_CustomerApiVendor_Map" type="org.qydata.entity.ApiType" extends="ApiType_Map">
        <collection property="customerApiVendorList" ofType="org.qydata.dst.CustomerApiVendor">
            <result column="apiId" property="apiId"/>
            <result column="totlePrice" property="totlePrice"/>
            <result column="vendorName" property="vendorName"/>
            <result column="vendorId" property="vendorId"/>
        </collection>
    </resultMap>

    <resultMap id="CustomerApiVendor_Map" type="org.qydata.dst.CustomerApiVendor" >
        <result column="apiId" property="apiId"/>
        <result column="apiName" property="apiName"/>
        <result column="totlePrice" property="totlePrice"/>
        <result column="vendorName" property="vendorName"/>
        <result column="vendorId" property="vendorId"/>
        <result column="reasonId" property="reasonId"/>
        <result column="reasonName" property="reasonName"/>
    </resultMap>

    <resultMap id="CustomerBalanceDetailConsume_Map" type="org.qydata.entity.CustomerBalanceLog" >
        <result column="reasonId" property="reasonId"/>
        <result column="amount" property="amount"/>
        <result column="customerId" property="customerId"/>
        <result column="createTime" property="createTime"/>
        <association property="customerBalanceModifyReason" javaType="org.qydata.entity.CustomerBalanceModifyReason">
            <result column="reasonName" property="name"/>
        </association>
       <association property="api" javaType="org.qydata.entity.Api">
           <result column="apiId" property="id"/>
           <result column="apiName" property="name"/>
       </association>
    </resultMap>


    <!--查询客户的财务总览-->
    <select id="queryCompanyCustomerOverAllFinanceByDept" parameterType="map" resultMap="CustomerFinance_CompanyApi_Map">
        SELECT kk.id,kk.companyId,kk.companyName,kk.balance,kk.partnerId,kk.partnerName,kk.chargeWeekTotleAmount,kk.chargeMonthTotleAmount,kk.consumeWeekTotleAmount,
        kk.consumeMonthTotleAmount,kk.chargeTotleAmount,ll.consumeTotleAmount,kk.apiTypeId,kk.apiTypeName,kk.subTypeId,kk.subTypeName,kk.price
        FROM
        (
        SELECT ii.id,ii.companyId,ii.companyName,ii.balance,ii.partnerId,ii.partnerName,ii.chargeWeekTotleAmount,ii.chargeMonthTotleAmount,ii.consumeWeekTotleAmount,
        ii.consumeMonthTotleAmount,jj.chargeTotleAmount,ii.apiTypeId,ii.apiTypeName,ii.subTypeId,ii.subTypeName,ii.price
        FROM
        (
        SELECT gg.id,gg.companyId,gg.companyName,gg.balance,gg.partnerId,gg.partnerName,gg.chargeWeekTotleAmount,gg.chargeMonthTotleAmount,gg.consumeWeekTotleAmount,
        hh.consumeMonthTotleAmount,gg.apiTypeId,gg.apiTypeName,gg.subTypeId,gg.subTypeName,gg.price
        FROM
        (
        SELECT ee.id,ee.companyId,ee.companyName,ee.balance,ee.partnerId,ee.partnerName,ee.chargeWeekTotleAmount,ee.chargeMonthTotleAmount,ff.consumeWeekTotleAmount,
        ee.apiTypeId,ee.apiTypeName,ee.subTypeId,ee.subTypeName,ee.price
        FROM
        (
        SELECT cc.id,cc.companyId,cc.companyName,cc.balance,cc.partnerId,cc.partnerName,cc.chargeWeekTotleAmount,dd.chargeMonthTotleAmount,
        cc.apiTypeId,cc.apiTypeName,cc.subTypeId,cc.subTypeName,cc.price
        FROM
        (
        SELECT aa.id,aa.typeId,aa.typeName,aa.name,aa.authId,aa.authPass,aa.createTime,aa.status,aa.statusName,aa.companyId,aa.companyName,aa.balance,aa.partnerId,aa.partnerName,bb.chargeWeekTotleAmount,
        aa.apiTypeId,aa.apiTypeName,aa.subTypeId,aa.subTypeName,aa.price
        FROM
            (
                SELECT a.id,a.typeId,a.typeName,a.name,a.authId,a.authPass,a.balance,a.partnerId,c.name partnerName,a.createTime,a.status,a.statusName,a.companyId,a.companyName,
                b.deptId,b.deptName,z.apiTypeId,z.apiTypeName,z.subTypeId,z.subTypeName,z.price
                FROM qyfinance.bkvwCustomer a LEFT JOIN qyauth.bkvwCustomerDept b ON a.id=b.customerId LEFT JOIN qyfinance.bk-bkvwPartner c
                ON a.partnerId=c.id  LEFT JOIN
                            (
                                SELECT a.companyId,a.apiTypeId,b.name apiTypeName,a.subTypeId,c.name subTypeName,a.price
                                FROM qyfinance.bkvwCompanyApi a LEFT JOIN qyfinance.bkvwApiType b
                                ON a.apiTypeId=b.id LEFT JOIN qyfinance.bkvwMobileOperator c ON a.subTypeId=c.id
                                WHERE a.enabled=1
                            ) z ON a.companyId=z.companyId
                <if test="deptIdList!=null and deptIdList.size()!=0">
                    and b.deptId in
                    <foreach collection="deptIdList" item="deptId" index="index" open="(" close=")" separator=",">
                        #{deptId}
                    </foreach>
                </if>
                <if test="customerTypeIdList!=null and customerTypeIdList.size()!=0">
                    and a.typeId in
                    <foreach collection="customerTypeIdList" item="customerTypeId" index="index" open="(" close=")" separator=",">
                        #{customerTypeId}
                    </foreach>
                </if>
                <if test="partnerId!=null and partnerId!=''">
                    and a.partnerId=#{partnerId}
                </if>
                <if test="content!=null and content!=''">
                    and a.companyName like '%${content}%'
                </if>
            ) aa LEFT JOIN
        (SELECT customerId,totleAmount chargeWeekTotleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE weekMonthTypeId=1 AND tableId=1 AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%x')
        AND weeks=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%v')
        ) bb
        ON aa.id=bb.customerId
        ) cc LEFT JOIN
        (SELECT customerId,totleAmount chargeMonthTotleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE weekMonthTypeId=2 AND tableId=1 AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 month),'%Y')
        AND months=DATE_FORMAT(date_sub(sysdate(),interval 1 month),'%m')
        ) dd
        ON cc.id=dd.customerId
        ) ee LEFT JOIN
        (SELECT customerId,totleAmount consumeWeekTotleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE weekMonthTypeId=1 AND tableId=2 AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%x')
        AND weeks=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%v')
        ) ff
        ON ee.id=ff.customerId
        ) gg LEFT JOIN
        (SELECT customerId,totleAmount consumeMonthTotleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE weekMonthTypeId=2 AND tableId=2 AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 month),'%Y')
        AND months=DATE_FORMAT(date_sub(sysdate(),interval 1 month),'%m')
        ) hh
        ON gg.id=hh.customerId
        ) ii LEFT JOIN
        (SELECT customerId,sum(amount) chargeTotleAmount
        FROM qyfinance.bkvwCustomerBalanceLog
        WHERE reasonId in (1,2,3)
        GROUP BY customerId
        ) jj
        ON ii.id=jj.customerId
        ) kk LEFT JOIN
        (SELECT customerId,sum(amount) consumeTotleAmount
        FROM qyfinance.bkvwCustomerBalanceLog
        WHERE reasonId in (-1,-2)
        GROUP BY customerId
        ) ll
        ON kk.id=ll.customerId
    </select>


    <select id="queryCompanyCustomerOverAllFinance" parameterType="map" resultMap="CustomerFinance_CompanyApi_Map">
        SELECT kk.id,kk.companyId,kk.companyName,kk.balance,kk.partnerId,kk.partnerName,kk.chargeWeekTotleAmount,kk.chargeMonthTotleAmount,kk.consumeWeekTotleAmount,
        kk.consumeMonthTotleAmount,kk.chargeTotleAmount,ll.consumeTotleAmount,kk.apiTypeId,kk.apiTypeName,kk.subTypeId,kk.subTypeName,kk.price
        FROM
        (
        SELECT ii.id,ii.companyId,ii.companyName,ii.balance,ii.partnerId,ii.partnerName,ii.chargeWeekTotleAmount,ii.chargeMonthTotleAmount,ii.consumeWeekTotleAmount,
        ii.consumeMonthTotleAmount,jj.chargeTotleAmount,ii.apiTypeId,ii.apiTypeName,ii.subTypeId,ii.subTypeName,ii.price
        FROM
        (
        SELECT gg.id,gg.companyId,gg.companyName,gg.balance,gg.partnerId,gg.partnerName,gg.chargeWeekTotleAmount,gg.chargeMonthTotleAmount,gg.consumeWeekTotleAmount,
        hh.consumeMonthTotleAmount,gg.apiTypeId,gg.apiTypeName,gg.subTypeId,gg.subTypeName,gg.price
        FROM
        (
        SELECT ee.id,ee.companyId,ee.companyName,ee.balance,ee.partnerId,ee.partnerName,ee.chargeWeekTotleAmount,ee.chargeMonthTotleAmount,ff.consumeWeekTotleAmount,
        ee.apiTypeId,ee.apiTypeName,ee.subTypeId,ee.subTypeName,ee.price
        FROM
        (
        SELECT cc.id,cc.companyId,cc.companyName,cc.balance,cc.partnerId,cc.partnerName,cc.chargeWeekTotleAmount,dd.chargeMonthTotleAmount,
        cc.apiTypeId,cc.apiTypeName,cc.subTypeId,cc.subTypeName,cc.price
        FROM
        (
        SELECT aa.id,aa.typeId,aa.typeName,aa.name,aa.authId,aa.authPass,aa.createTime,aa.status,aa.statusName,aa.companyId,aa.companyName,aa.balance,aa.partnerId,aa.partnerName,bb.chargeWeekTotleAmount,
        aa.apiTypeId,aa.apiTypeName,aa.subTypeId,aa.subTypeName,aa.price
        FROM
        (
            SELECT a.id,a.typeId,a.typeName,a.name,a.authId,a.authPass,a.balance,a.createTime,a.status,a.statusName,a.companyId,a.companyName,a.partnerId,b.name partnerName,
            z.apiTypeId,z.apiTypeName,z.subTypeId,z.subTypeName,z.price
            FROM qyfinance.bkvwCustomer a LEFT JOIN qyfinance.bkvwPartner b ON a.partnerId=b.id
            LEFT JOIN
            (
            SELECT a.companyId,a.apiTypeId,b.name apiTypeName,a.subTypeId,c.name subTypeName,a.price
            FROM qyfinance.bkvwCompanyApi a LEFT JOIN qyfinance.bkvwApiType b
            ON a.apiTypeId=b.id LEFT JOIN qyfinance.bkvwMobileOperator c ON a.subTypeId=c.id
            WHERE a.enabled=1
            ) z ON a.companyId=z.companyId
            <where>
                <if test="customerTypeIdList!=null and customerTypeIdList.size()!=0">
                     a.typeId in
                    <foreach collection="customerTypeIdList" item="customerTypeId" index="index" open="(" close=")" separator=",">
                        #{customerTypeId}
                    </foreach>
                </if>
                <if test="partnerId!=null and partnerId!=''">
                    and a.partnerId=#{partnerId}
                </if>
                <if test="content!=null and content!=''">
                    and a.companyName like '%${content}%'
                </if>
            </where>
        ) aa LEFT JOIN
        (SELECT customerId,totleAmount chargeWeekTotleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE weekMonthTypeId=1 AND tableId=1 AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%x')
        AND weeks=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%v')
        ) bb
        ON aa.id=bb.customerId
        ) cc LEFT JOIN
        (SELECT customerId,totleAmount chargeMonthTotleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE weekMonthTypeId=2 AND tableId=1 AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 month),'%Y')
        AND months=DATE_FORMAT(date_sub(sysdate(),interval 1 month),'%m')
        ) dd
        ON cc.id=dd.customerId
        ) ee LEFT JOIN
        (SELECT customerId,totleAmount consumeWeekTotleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE weekMonthTypeId=1 AND tableId=2 AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%x')
        AND weeks=DATE_FORMAT(date_sub(sysdate(),interval 1 week),'%v')
        ) ff
        ON ee.id=ff.customerId
        ) gg LEFT JOIN
        (SELECT customerId,totleAmount consumeMonthTotleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE weekMonthTypeId=2 AND tableId=2 AND years=DATE_FORMAT(date_sub(sysdate(),interval 1 month),'%Y')
        AND months=DATE_FORMAT(date_sub(sysdate(),interval 1 month),'%m')
        ) hh
        ON gg.id=hh.customerId
        ) ii LEFT JOIN
        (SELECT customerId,sum(amount) chargeTotleAmount
        FROM qyfinance.bkvwCustomerBalanceLog
        WHERE reasonId in (1,2,3)
        GROUP BY customerId
        ) jj
        ON ii.id=jj.customerId
        ) kk LEFT JOIN
        (SELECT customerId,sum(amount) consumeTotleAmount
        FROM qyfinance.bkvwCustomerBalanceLog
        WHERE reasonId in (-1,-2)
        GROUP BY customerId
        ) ll
        ON kk.id=ll.customerId
    </select>

    <!--查询客户的充值记录-->
    <select id="queryCompanyCustomerRechargeRecordByCustomerId" parameterType="map" resultMap="CustomerBalanceLog_CustomerBalanceModifyReason_Map">
        SELECT id,reasonId,amount,customerId,createTime,reasonName
        FROM qyfinance.bkvwCustomerBalanceLog
        WHERE customerId=#{customerId}
        <if test="reasonIdList != null and reasonIdList.size() != 0">
            AND reasonId IN
            <foreach collection="reasonIdList" item="reasonId" index="index" open="(" close=")" separator=",">
                #{reasonId}
            </foreach>
        </if>
        <if test="beginDate != null and beginDate != ''">
            <![CDATA[
            AND createTime>=str_to_date(#{beginDate},'%m/%d/%Y %H:%i:%s')
            ]]>
        </if>
        <if test="endDate != null and endDate != ''">
            <![CDATA[
            AND createTime<=str_to_date(#{endDate},'%m/%d/%Y %H:%i:%s')
             ]]>
        </if>
        ORDER BY createTime DESC
    </select>

    <!--查询客户的Api消费记录-->
    <select id="queryCompanyCustomerApiConsumeRecordByCustomerId" parameterType="map" resultMap="ApiType_CustomerApiVendor_Map">
        select ee.apiTypeId,ff.name typeName,ee.apiId,ee.totlePrice,ee.vendorName,ee.vendorId
        from
        (
            select cc.apiTypeId,cc.apiId,cc.totlePrice,dd.vendorName,dd.vendorId
            from
            (
                select b.apiTypeId,b.apiId,sum(a.amount) totlePrice
                from qyfinance.bkvwCustomerBalanceLog a LEFT JOIN qyfinance.bkvwCustomerRequestLog b
                ON a.reqId=b.id
                where a.reasonId in(-1,-2) and b.hasCost=1
                and a.customerId=#{customerId}
                group by b.apiTypeId,b.apiId
            ) cc LEFT JOIN qyfinance.bkvwApi dd
            ON cc.apiId = dd.id
        ) ee LEFT JOIN qyfinance.bkvwApiType ff
        ON ee.apiTypeId=ff.id
        <where>
            <if test="apiTypeId != null and apiTypeId != ''">
                ee.apiTypeId=#{apiTypeId}
            </if>
            <if test="apiVendorId != null and apiVendorId != ''">
                AND ee.vendorId=#{apiVendorId}
            </if>
        </where>
    </select>

    <!--查询客户的Api消费明细记录-->
    <select id="queryCompanyCustomerApiDetailConsumeRecordByCustomerId" parameterType="map" resultMap="CustomerBalanceDetailConsume_Map">
       select aa.reasonId,aa.amount,aa.customerId,aa.createTime,aa.reasonName,aa.apiTypeId,aa.apiId,bb.name apiName
        from
        (
            select a.reasonId,a.amount,a.customerId,a.createTime,a.reasonName,b.apiTypeId,b.apiId
            from qyfinance.bkvwCustomerBalanceLog a LEFT JOIN qyfinance.bkvwCustomerRequestLog b
            ON a.reqId=b.id
            where b.hasCost=1 and a.customerId=#{customerId}
            <if test="reasonIdList != null and reasonIdList.size() > 0">
                AND a.reasonId IN
                <foreach collection="reasonIdList" item="reasonId" index="index" open="(" close=")" separator=",">
                    #{reasonId}
                </foreach>
            </if>
        ) aa left join qyfinance.bkvwApi bb on aa.apiId=bb.id
        <where>
            <if test="apiTypeId != null and apiTypeId != ''">
                aa.apiTypeId=#{apiTypeId}
            </if>
            <if test="beginDate != null and beginDate != ''">
                <![CDATA[
            AND aa.createTime>=str_to_date(#{beginDate},'%m/%d/%Y %H:%i:%s')
            ]]>
            </if>
            <if test="endDate != null and endDate != ''">
                <![CDATA[
            AND aa.createTime<=str_to_date(#{endDate},'%m/%d/%Y %H:%i:%s')
             ]]>
            </if>
        </where>
    </select>

    <!--查询客户的周月记录-->
    <select id="queryCompanyCustomerWeekMonthRecordByCustomerId" parameterType="map" resultType="org.qydata.entity.WeekMonthAmount">
        SELECT years,months,weeks,totleAmount,customerId,tableId,weekMonthTypeId,name,beginTime,endTime
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE customerId=#{customerId}
        AND weekMonthTypeId=#{weekMonthTypeId}
        <if test="years != null and years != ''">
            AND years=#{years}
        </if>
        <if test="months != null and months != ''">
            AND months=#{months}
        </if>
        <if test="weeks != null and weeks != ''">
            AND weeks=#{weeks}
        </if>
        <if test="tableIdList != null and tableIdList.size() > 0">
            AND tableId IN
            <foreach collection="tableIdList" item="tableId" index="index" open="(" close=")" separator=",">
                #{tableId}
            </foreach>
        </if>
    </select>

    <!--查询客户的周月记录年级联菜单-->
    <select id="queryCompanyCustomerYearsByCustomerId" parameterType="map" resultType="int">
        SELECT DISTINCT(years)
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE customerId=#{customerId} AND weekMonthTypeId=#{weekMonthTypeId}
        <if test="years != null and years != ''">
            AND years=#{years}
        </if>
        <if test="months != null and months != ''">
            AND months=#{months}
        </if>
        <if test="weeks != null and weeks != ''">
            AND weeks=#{weeks}
        </if>
        <if test="tableIdList != null and tableIdList.size() > 0">
            AND tableId IN
            <foreach collection="tableIdList" item="tableId" index="index" open="(" close=")" separator=",">
                #{tableId}
            </foreach>
        </if>
    </select>

    <!--查询客户的周月记录月级联菜单-->
    <select id="queryCompanyCustomerMonthsByCustomerId" parameterType="map" resultType="int">
        SELECT DISTINCT(months)
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE customerId=#{customerId}
        <if test="weekMonthTypeId != null and weekMonthTypeId != ''">
            AND weekMonthTypeId=#{weekMonthTypeId}
        </if>
        <if test="years != null and years != ''">
            AND years=#{years}
        </if>
        <if test="tableIdList != null and tableIdList.size() > 0">
            AND tableId IN
            <foreach collection="tableIdList" item="tableId" index="index" open="(" close=")" separator=",">
                #{tableId}
            </foreach>
        </if>
    </select>

    <!--查询客户的周月记录周级联菜单-->
    <select id="queryCompanyCustomerWeeksByCustomerId" parameterType="map" resultType="int">
        SELECT DISTINCT(weeks)
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE customerId=#{customerId} AND weekMonthTypeId=#{weekMonthTypeId}
        <if test="years != null and years != ''">
            AND years=#{years}
        </if>
        <if test="months != null and months != ''">
            AND months=#{months}
        </if>
        <if test="weeks != null and weeks != ''">
            AND weeks=#{weeks}
        </if>
        <if test="tableIdList != null and tableIdList.size() > 0">
            AND tableId IN
            <foreach collection="tableIdList" item="tableId" index="index" open="(" close=")" separator=",">
                #{tableId}
            </foreach>
        </if>
    </select>

    <!--月账单走势图-->
    <select id="queryMonthChargeConsumeToward" parameterType="Integer" resultType="org.qydata.entity.WeekMonthAmount">
        SELECT years,months,totleAmount
        FROM qyfinance.bkvwWeekMonthAmount
        WHERE customerId=#{param1}
        AND weekMonthTypeId=2
        AND tableId=#{param2}
        AND DATE_FORMAT(endTime,'%Y-%m')=DATE_FORMAT(date_sub(sysdate(),interval #{param3} month),'%Y-%m')
    </select>

    <!--查询客户各供应商消费情况-->
    <select id="queryCustomerConsumeByVendor" parameterType="map" resultMap="CustomerApiVendor_Map">
        select ee.apiTypeId,ff.name typeName,ee.apiId,ee.totlePrice,ee.vendorName,ee.vendorId,ee.apiName
        from
        (
            select cc.apiTypeId,cc.apiId,cc.totlePrice,dd.vendorName,dd.vendorId,dd.name apiName
            from
            (
                select b.apiTypeId,b.apiId,sum(a.amount) totlePrice
                from qyfinance.bkvwCustomerBalanceLog a LEFT JOIN qyfinance.bkvwCustomerRequestLog b
                ON a.reqId=b.id
                where a.customerId=#{customerId} AND b.hasCost=1 AND a.reasonId IN(-1,-2)
                group by b.apiTypeId,b.apiId
            ) cc LEFT JOIN qyfinance.bkvwApi dd ON cc.apiId = dd.id
        ) ee LEFT JOIN qyfinance.bkvwApiType ff ON ee.apiTypeId=ff.id
        WHERE ee.apiTypeId=#{apiTypeId}
    </select>

</mapper>

