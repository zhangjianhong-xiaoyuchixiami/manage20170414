<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.qydata.mapper.ApiWeekMonthAmountMapper">

    <resultMap id="ApiWeekMonthAmount_Map" type="org.qydata.entity.ApiWeekMonthAmount">
        <result column="years" property="years"/>
        <result column="months" property="months"/>
        <result column="weeks" property="weeks"/>
        <result column="totleCost" property="totleCost"/>
        <result column="apiId" property="apiId"/>
        <result column="temporal" property="temporal"/>
    </resultMap>


    <!--统计Api每周的消费数据-->
    <select id="getAllApiWeekConsumeRecord" parameterType="Integer" resultMap="ApiWeekMonthAmount_Map">
       SELECT a.id apiId,b.years,b.weeks,b.totleCost,b.temporal
        FROM qyfinance.bkvwApi a LEFT JOIN
        (
            SELECT DATE_FORMAT(createTime,'%x') years,DATE_FORMAT(createTime,'%v') weeks,
            SUM(cost) totleCost,apiId,GROUP_CONCAT(DISTINCT(DATE(createTime)) ORDER BY DATE(createTime) ASC) temporal
            FROM qyfinance.bkvwApiRequestLog
            WHERE ok=1 AND DATE_FORMAT(createTime,'%x-%v')=DATE_FORMAT(date_sub(sysdate(),interval #{param} week),'%x-%v')
            GROUP BY DATE_FORMAT(createTime,'%x-%v'),apiId
        ) b ON  a.id=b.apiId
    </select>

    <!--统计Api每月的消费数据-->
    <select id="getAllApiMonthConsumeRecord" parameterType="Integer" resultMap="ApiWeekMonthAmount_Map">
       SELECT a.id apiId,b.years,b.months,b.totleCost,b.temporal
        FROM qyfinance.bkvwApi a LEFT JOIN
        (
            SELECT DATE_FORMAT(createTime,'%Y') years,DATE_FORMAT(createTime,'%m') months,SUM(cost) totleCost,apiId,
            GROUP_CONCAT(DISTINCT(DATE(createTime)) ORDER BY DATE(createTime) ASC) temporal
            FROM qyfinance.bkvwApiRequestLog
            WHERE ok=1 AND DATE_FORMAT(createTime,'%Y-%m')=DATE_FORMAT(date_sub(sysdate(),interval #{param} month),'%Y-%m')
            GROUP BY DATE_FORMAT(createTime,'%Y-%m'),apiId
        ) b ON  a.id=b.apiId
    </select>

    <!--删除Api每周的数据-->
    <delete id="deleteApiWeekRecord" parameterType="map">
        DELETE FROM qyfinance.ApiWeekMonthAmount WHERE years=#{year} AND months=#{month}
        AND weeks=#{week} AND typeId=#{typeId} AND tableId=#{tableId}
    </delete>

    <!--删除Api每月的数据-->
    <delete id="deleteApiMonthRecord" parameterType="map">
        DELETE FROM qyfinance.ApiWeekMonthAmount WHERE years=#{year} AND months=#{month}
        AND typeId=#{typeId} AND tableId=#{tableId}
    </delete>

    <!--插入Api每周的数据-->
    <insert id="addApiWeekRecord" parameterType="list" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO qyfinance.ApiWeekMonthAmount(years,months,weeks,apiId,totleCost,tableId,TypeId,
        beginTime,endTime,createTime)
        VALUES
        <foreach collection="list" item="apiWeekMonthAmount" index="index" separator=",">
            (
            #{apiWeekMonthAmount.years},#{apiWeekMonthAmount.months},#{apiWeekMonthAmount.weeks},#{apiWeekMonthAmount.apiId},
            #{apiWeekMonthAmount.totleCost},#{apiWeekMonthAmount.tableId},#{apiWeekMonthAmount.typeId},#{apiWeekMonthAmount.beginTime},
            #{apiWeekMonthAmount.endTime},sysdate()
            )
        </foreach>
    </insert>

    <!--插入Api每月的数据-->
    <insert id="addApiMonthRecord" parameterType="list" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO qyfinance.ApiWeekMonthAmount(years,months,apiId,totleCost,tableId,TypeId,
        beginTime,endTime,createTime)
        VALUES
        <foreach collection="list" item="apiWeekMonthAmount" index="index" separator=",">
            (
            #{apiWeekMonthAmount.years},#{apiWeekMonthAmount.months},#{apiWeekMonthAmount.apiId},#{apiWeekMonthAmount.totleCost},
            #{apiWeekMonthAmount.tableId},#{apiWeekMonthAmount.typeId},#{apiWeekMonthAmount.beginTime},
            #{apiWeekMonthAmount.endTime},sysdate()
            )
        </foreach>
    </insert>



</mapper>