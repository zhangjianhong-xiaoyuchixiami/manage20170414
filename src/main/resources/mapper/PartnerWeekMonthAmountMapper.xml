<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.qydata.mapper.PartnerWeekMonthAmountMapper">

    <resultMap id="PartnerWeekMonthAmount_Map" type="org.qydata.entity.PartnerWeekMonthAmount">
        <result column="years" property="years"/>
        <result column="months" property="months"/>
        <result column="weeks" property="weeks"/>
        <result column="totleAmount" property="totleAmount"/>
        <result column="partnerId" property="partnerId"/>
        <result column="temporal" property="temporal"/>
    </resultMap>

    <!--统计合作公司每周的付款数据-->
    <select id="getAllPartnerWeekPaymentRecord" parameterType="Integer" resultMap="PartnerWeekMonthAmount_Map">
       SELECT a.id partnerId,b.years,b.weeks,b.totleAmount,b.temporal
        FROM qyfinance.bkvwPartner a LEFT JOIN
        (
            SELECT DATE_FORMAT(createTime,'%x') years,DATE_FORMAT(createTime,'%v')weeks,sum(amount) totleAmount,partnerId,
            GROUP_CONCAT(DISTINCT DATE(createTime) ORDER BY DATE(createTime) ASC) temporal
            FROM qyfinance.PartnerIncomeExpenditureLog
            WHERE reasonId = 2
            AND DATE_FORMAT(createTime,'%x-%v')=DATE_FORMAT(date_sub(sysdate(),interval #{param} week),'%x-%v')
            GROUP BY DATE_FORMAT(createTime,'%x-%v'),partnerId
        ) b ON a.id=b.partnerId
    </select>

    <!--统计合作公司每月的付款数据-->
    <select id="getAllPartnerMonthPaymentRecord" parameterType="Integer" resultMap="PartnerWeekMonthAmount_Map">
        SELECT a.id partnerId,b.years,b.months,b.totleAmount,b.temporal
        FROM qyfinance.bkvwPartner a LEFT JOIN
        (
            SELECT DATE_FORMAT(createTime,'%Y') years,DATE_FORMAT(createTime,'%m') months,sum(amount) totleAmount,partnerId,
            GROUP_CONCAT(DISTINCT DATE(createTime) ORDER BY DATE(createTime) ASC) temporal
            FROM qyfinance.PartnerIncomeExpenditureLog
            WHERE reasonId = 2
            AND DATE_FORMAT(createTime,'%Y-%m')=DATE_FORMAT(date_sub(sysdate(),interval #{param} month),'%Y-%m')
            GROUP BY DATE_FORMAT(createTime,'%Y-%m'),partnerId
        ) b ON a.id=b.partnerId
    </select>

    <!--插入合作公司每周的数据-->
    <insert id="addWeekRecord" parameterType="list" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO qyfinance.PartnerWeekMonthAmount(years,months,weeks,totleAmount,partnerId,typeId,reasonId,
        beginTime,endTime,createTime)
        VALUES
        <foreach collection="list" item="partnerWeekMonthAmount" index="index" separator=",">
            (
            #{partnerWeekMonthAmount.years},#{partnerWeekMonthAmount.months},#{partnerWeekMonthAmount.weeks},#{partnerWeekMonthAmount.totleAmount},
            #{partnerWeekMonthAmount.partnerId},#{partnerWeekMonthAmount.typeId},#{partnerWeekMonthAmount.reasonId},#{partnerWeekMonthAmount.beginTime},
            #{partnerWeekMonthAmount.endTime},sysdate()
            )
        </foreach>
    </insert>

    <!--插入合作公司每月的数据-->
    <insert id="addMonthRecord" parameterType="list" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO qyfinance.PartnerWeekMonthAmount(years,months,totleAmount,partnerId,typeId,reasonId,
        beginTime,endTime,createTime)
        VALUES
        <foreach collection="list" item="partnerWeekMonthAmount" index="index" separator=",">
            (
            #{partnerWeekMonthAmount.years},#{partnerWeekMonthAmount.months},#{partnerWeekMonthAmount.totleAmount},#{partnerWeekMonthAmount.partnerId},
            #{partnerWeekMonthAmount.typeId},#{partnerWeekMonthAmount.reasonId},#{partnerWeekMonthAmount.beginTime},
            #{partnerWeekMonthAmount.endTime},sysdate()
            )
        </foreach>
    </insert>

    <!--统计合作公司每周的收款数据-->
    <select id="getAllPartnerWeekReceiptRecord" parameterType="Integer" resultMap="PartnerWeekMonthAmount_Map">
         SELECT a.id partnerId,b.years,b.weeks,b.totleAmount,b.temporal
        FROM qyfinance.bkvwPartner a LEFT JOIN
        (
            SELECT DATE_FORMAT(createTime,'%x') years,DATE_FORMAT(createTime,'%v')weeks,sum(amount) totleAmount,partnerId,
            GROUP_CONCAT(DISTINCT DATE(createTime) ORDER BY DATE(createTime) ASC) temporal
            FROM qyfinance.PartnerIncomeExpenditureLog
            WHERE reasonId = 1
            AND DATE_FORMAT(createTime,'%x-%v')=DATE_FORMAT(date_sub(sysdate(),interval #{param} week),'%x-%v')
            GROUP BY DATE_FORMAT(createTime,'%x-%v'),partnerId
        ) b ON a.id=b.partnerId
    </select>

    <!--统计合作公司每月的收款数据-->
    <select id="getAllPartnerMonthReceiptRecord" parameterType="Integer" resultMap="PartnerWeekMonthAmount_Map">
        SELECT a.id partnerId,b.years,b.months,b.totleAmount,b.temporal
        FROM qyfinance.bkvwPartner a LEFT JOIN
        (
            SELECT DATE_FORMAT(createTime,'%Y') years,DATE_FORMAT(createTime,'%m') months,sum(amount) totleAmount,partnerId,
            GROUP_CONCAT(DISTINCT DATE(createTime) ORDER BY DATE(createTime) ASC) temporal
            FROM qyfinance.PartnerIncomeExpenditureLog
            WHERE reasonId = 1
            AND DATE_FORMAT(createTime,'%Y-%m')=DATE_FORMAT(date_sub(sysdate(),interval #{param} month),'%Y-%m')
            GROUP BY DATE_FORMAT(createTime,'%Y-%m'),partnerId
        ) b ON a.id=b.partnerId
    </select>

</mapper>